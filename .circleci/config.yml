# Java Maven CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-java/ for more details
#

version: 2.1

executors:
  execute_test_cases:
    working_directory: ~/repo
    docker:
      - image: circleci/node:lts
  robot_autotest_executor:
    machine: true
    working_directory: ~/robot

commands:
  push_test_case_package:
    description: "sync application or msv package files to aws s3"
    parameters:
      from:
        type: string
      to:
        type: string
    steps:
      - run:
          name: push test case package to s3
          command: "aws s3 sync << parameters.from >> << parameters.to >> --delete"

  pull_mobile_app_from_s3:
    description: "pull application or msv package files to local docker"
    parameters:
      from:
        type: string
      to:
        type: string
    steps:
      - run:
          name: pull mobile app from s3
          command: "aws s3 cp << parameters.from >> << parameters.to >> --recursive"

  package_test_case :
    description: "mvn package for multi-env and different devices"
    parameters:
      envType:
        type: string
      deviceType:
        type: string
    steps:
      - run:
          name: << parameters.envType >> | << parameters.deviceType >> === mvn package
          command: |
            mvn clean -DPLATFORM_NAME=<< parameters.deviceType >> -DENV_NAME=<< parameters.envType >> -DskipTests -P prepare-for-upload package

      - run:
          name: << parameters.envType >> | << parameters.deviceType >> === backup package
          command: |
            mkdir -p artifactWorkspace
            mv target/upload artifactWorkspace/upload-<<parameters.envType>>-<< parameters.deviceType >>
            ls artifactWorkspace/

  run_test_cases_android:
    description: "run the test case on the AppCenter platform"
    parameters:
      envType:
        type: string
      appName:
        type: string
    steps:
      - attach_workspace:
          at: ~/repo/
      - run:
          name: install app center cli
          command: sudo npm install -g appcenter-cli

      - run:
          name: list artifactWorkspace
          command: |
            ls artifactWorkspace

      - run:
          name: test app UI -- Android
          command: |
            appcenter test run appium --app "NEXT_DEV/NEXTTrucking-Android" --devices decd45e5 --app-path "artifactWorkspace/<<parameters.appName>>.apk" --test-series "master" --locale "en_US" --build-dir artifactWorkspace/upload-<<parameters.envType>>-android

  run_test_cases_ios:
    description: "run the test case on the AppCenter platform"
    parameters:
      envType:
        type: string
      appName:
        type: string
    steps:
      - attach_workspace:
          at: ~/repo/
      - run:
          name: install app center cli
          command: sudo npm install -g appcenter-cli

      - run:
          name: list artifactWorkspace
          command: |
            ls artifactWorkspace

      - run:
          name: test app UI -- iOS
          command: |
            appcenter test run appium --app "NEXT_DEV/NEXTTrucking-iOS" --devices 63a899df --app-path "artifactWorkspace//<<parameters.appName>>.ipa" --test-series "master" --locale "en_US" --build-dir artifactWorkspace/upload-<<parameters.envType>>-ios

  robot_autotest:
    description: "Robot auto test, UI testing or build test data"
    parameters:
      ENV:
        type: string
      TYPE:
        type: string
      EXCLUDE:
        type: string
        default: ""
    steps:
      - run:
          name: Start << parameters.ENV >> << parameters.TYPE >>
          environment:
            ENV: << parameters.ENV >>
            TYPE: << parameters.TYPE >>
            EXCLUDE: << parameters.EXCLUDE >>
          command: |
            $(aws ecr get-login --no-include-email --region $AWS_DEFAULT_REGION)
            docker pull $DOCKER_REPO_URL/robot-autotest
            echo "Robot autotest running, env: ${ENV}, type: ${TYPE}, exclude: ${EXCLUDE}"
            docker run -e ENV=${ENV} -e TYPE=${TYPE} -e EXCLUDE=${EXCLUDE} $DOCKER_REPO_URL/robot-autotest

jobs:
  build:
    docker:
      - image: circleci/openjdk:8-jdk
    working_directory: ~/repo

    steps:
      - checkout

      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-

      - run: mvn dependency:go-offline

      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "pom.xml" }}

      - package_test_case :
          envType: "dev"
          deviceType: "android"

      - package_test_case :
          envType: "dev"
          deviceType: "ios"

      - package_test_case :
          envType: "test"
          deviceType: "android"

      - package_test_case :
          envType: "test"
          deviceType: "ios"

      - package_test_case :
          envType: "demo"
          deviceType: "android"

      - package_test_case :
          envType: "demo"
          deviceType: "ios"

      - persist_to_workspace:
          # Save the files in persist_to_workspace
          root: ~/repo
          paths:
            - artifactWorkspace

  prepare_test_cases_and_mobile_app:
    docker:
      - image: circleci/python:2.7-jessie
    working_directory: ~/repo
    steps:
      - attach_workspace:
          at: ~/repo/

      - run:
          name: Install awscli
          command: sudo pip install awscli

      - push_test_case_package:
          from: "artifactWorkspace"
          to: "s3://next-app-ui-test/test-package"

      - pull_mobile_app_from_s3:
          from: "s3://next-app-ui-test/app-package"
          to: "artifactWorkspace"

      - run:
          name: list artifactWorkspace
          command: |
            ls artifactWorkspace

      - persist_to_workspace:
          # Save the files in persist_to_workspace
          root: ~/repo
          paths:
            - artifactWorkspace

  dev_init_data_android:
    executor: robot_autotest_executor
    steps:
      - robot_autotest:
          ENV: "dev"
          TYPE: "InitData"

  testDevAndroid:
    executor: execute_test_cases
    steps:
      - run_test_cases_android:
          envType: "dev"
          appName: "$APP_NAME_DEV"

  dev_init_data_ios:
    exectur: robot_autotest_executor
    steps:
      - robot_autotest:
          ENV: "dev"
          TYPE: "InitData"

  testDevIOS:
    executor: execute_test_cases
    steps:
      - run_test_cases_ios:
          envType: "dev"
          appName: "$APP_NAME_DEV"

  test_init_data_andoid:
    executor: robot_autotest_executor
    steps:
      - robot_autotest:
          ENV: "test"
          TYPE: "InitData"

  testTestAndroid:
    executor: execute_test_cases
    steps:
      - run_test_cases_android:
          envType: "test"
          appName: "$APP_NAME_DEV"

  test_init_data_ios:
    executor: robot_autotest_executor
    steps:
      - robot_autotest:
          ENV: "test"
          TYPE: "InitData"

  testTestIOS:
    executor: execute_test_cases
    steps:
       - run_test_cases_ios:
          envType: "test"
          appName: "$APP_NAME_DEV"

workflows:
  version: 2
  app-ui-test:
    jobs:
      - build

      - prepare_test_cases_and_mobile_app:
          context: next-platform-build
          requires:
            - build
          filters:
            branches:
              only:
                - master
                - /^release\/.*/
                - feature/circleci

      - hold_testDevUI:
          type: approval
          requires:
            - prepare_test_cases_and_mobile_app
      - dev_init_data_andoid:
          context: next-platform-build
          requires:
            - hold_testDevUI
      - testDevAndroid:
          context: next-platform-build
          requires:
            - dev_init_data_andoid
      - dev_init_data_ios:
          context: next-platform-build
          requires:
            - testDevAndroid
      - testDevIOS:
          context: next-platform-build
          requires:
            - dev_init_data_ios
      - hold_testTestUI:
          type: approval
          requires:
            - prepare_test_cases_and_mobile_app
      - test_init_data_android:
          context: next-platform-build
          requires:
            - hold_testTestUI
      - testTestAndroid:
          context: next-platform-build
          requires:
            - test_init_data_android
      - test_init_data_ios:
          context: next-platform-build
          requires:
            - testTestAndroid
      - testTestIOS:
          context: next-platform-build
          requires:
            - test_init_data_ios
      - hold_testDemoUI:
          type: approval
          requires:
            - prepare_test_cases_and_mobile_app
      - testDemoAPP:
          context: next-platform-build
          requires:
            - hold_testDemoUI
  app-ui-timing-test:
    triggers:
      - schedule:
          cron: "0 8 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - build
      - prepare_test_cases_and_mobile_app:
          context: next-platform-build
          requires:
            - build
          filters:
            branches:
              only:
                - master
      - dev_init_data_android:
          context: next-platform-build
          requires:
            - prepare_test_cases_and_mobile_app
      - testDevAndroid:
          context: next-platform-build
          requires:
            - dev_init_data_android
      - dev_init_data_ios:
          context: next-platform-build
          requires:
            - testDevAndroid
      - testDevIOS:
          context: next-platform-build
          requires:
            - dev_init_data_ios